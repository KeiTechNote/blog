---
title: 업그레이드 가능한 스마트 컨트랙트 (10) - EIP-1014
date: 2023-09-15 23:30 +09:00
published: true
categories: [BlockChain]
tags: [BlockChain, Dev, Smart Contract, Proxy, Upgradeable Smart Contract, Solidity, 번역]
---

## EIP-1014 (번역_한글)
- 원문/출처 : https://eips.ethereum.org/EIPS/eip-1014

***본 컨텐츠는 원문/출처의 내용을 한글 번역한 내용입니다. 일부 오역이 있을 수 있으며 필요시 삭제될 수 있습니다.**

### Specification

새롭게 추가된 OpCode `0xf5`(`CREATE2`) 는 4개의 스택변수를 갖습니다. : endowment, memory_start, memory_length, salt.

![CREATE2_OpCode](/assets/images/CREATE2_OpCode_Parameters.png){: .shadow }
_CREATE2 OpCode (출처 : [ethervm.io][ethervm.io])_

> OpCode 를 살펴보는 웹 사이트마다 명칭은 서로 다르지만 의미는 동일하다. 
{: .prompt-info}

컨트랙트 초기화 주소로 sender, nonce, hash 를 사용하는 대신, `keccak256(0xff ++ address ++ salt ++ keccak256(init_code))[12:]`를 사용하는 것을 제외하면 `CREATE`(`0xf0`) 와 CREATE2 는 동작이 동일합니다. 

`CREATE2`는 `CREATE`처럼 `gas`를 갖지만, 해시 연산의 성능을 고려한 `GSHA2WORD * ceil(len(init_code) / 32)`의 추가 `hashcost`를 갖습니다. `hashcost`는 메모리 확장 Gas처럼 동시에 차감되고 `CreateGas`는 `init_code`실행 결과를 변환하기 전에 차감됩니다. 

- `0xff` : 1byte
- `address` : `20`bytes
- `salt` : `32`bytes

그러므로 최종 해싱 라운드의 preimage 는 항상 85bytes입니다. 
2018년 8월 10일 coredev-call 에서 위 공식을 사용하기로 결정했습니다. 


### 동기 (Motivation)

아직 온체인에는 없지만, 초기화 코드가 생성한 코드가 포함된 주소와 상호작용이 가능합니다. state-channel 사용사례의 중요한 점은 컨트랙트와 반대되는 상호작용이 포함될 수 있다는 점입니다. 

### 이론적 근거 (Rationale)

#### 주소 연산 (Address Formula)

- `0xff`는 수 페타바이트 데이터의 RLP 시작 1byte 만 될 수 있으므로, 이 방식으로 생성된 주소가 기존의 `keccak256(rlp([sender, nonce]))` 연산으로 생성된 주소와 충돌이 발생하지 않도록 합니다. 
- 해시 preimage 가 고정크기인지 확인합니다. 

#### 가스비용 (Gas Cost)

주소 연산은 `초기화 코드`해싱에 의존하고 메모리 확장 비용은 한번만 지불하므로, 규모가 큰 `초기화 코드`해싱을 반복적으로 실행할 수 있다면, 클라이언트는 DoS 공격에 노출될 수 있습니다. 본 EIP 는 `SHA3` OpCode 와 같은 단어당 비용을 사용합니다. 

#### 설명 (Clarifications)

`초기화 코드`는 실행될 때, 런타임 바이트코드를 생성해 state 로 두고, 일반적으로 상위 언어에서는 'constructor'로 구현됩니다. 이는 충돌가능성이 있으며 충돌시 동작은 EIP-684 에 명시하고 있습니다. 

> 컨트랙트 생성이 생성 트랜잭션이나 CREATE (향후 CREATE2) OpCode로 시도되고, 대상 주소는 0 이 아닌 nonce 나 비어있지 않는 코드가 있다면, 즉시 생성이 실패됩니다. 이는 초기화 코드 첫 1byte 가 유효하지 않은 OpCode 일 때와 동일한 동작입니다. 이는 생성부터 적용됩니다 

특히 `nonce` 나 `코드`는 0 이 아니므로, create 동작은 실패합니다. 
EIP-161 에서

> 계정 생성 트랜잭션과 `CREATE` 동작은 초기화 코드 실행 전, nonce 를 1씩 증가시킵니다. 

만약 트랜잭션에서 컨트랙트가 생성되면, `nonce`는 0 이 아닌 값이 되고, 동일한 트랜잭션에서 충돌이 발생하면, `초기화 코드` 자체에서 수행하더라도 항상 실패하게 됩니다. 
또한, selfdestruct (0xff) 는 nonce 나 코드에 즉각적인 영향을 미치지 않으므로, 단일 트랜잭션에서 컨트랙트를 파괴하고 재생성할 수 있습니다. 

### 예제 (Example)

- Example 0
    - address `0x0000000000000000000000000000000000000000`
    - salt `0x0000000000000000000000000000000000000000000000000000000000000000`
    - init_code `0x00`
    - gas (assuming no mem expansion): `32006`
    - result: `0x4D1A2e2bB4F88F0250f26Ffff098B0b30B26BF38`


- Example 1
    - address `0xdeadbeef00000000000000000000000000000000`
    - salt `0x0000000000000000000000000000000000000000000000000000000000000000`
    - init_code `0x00`
    - gas (assuming no mem expansion): `32006`
    - result: `0xB928f69Bb1D91Cd65274e3c79d8986362984fDA3`


- Example 2
    - address `0xdeadbeef00000000000000000000000000000000`
    - salt `0x000000000000000000000000feed000000000000000000000000000000000000`
    - init_code `0x00`
    - gas (assuming no mem expansion): `32006`
    - result: `0xD04116cDd17beBE565EB2422F2497E06cC1C9833`


- Example 3
    - address `0x0000000000000000000000000000000000000000`
    - salt `0x0000000000000000000000000000000000000000000000000000000000000000`
    - init_code `0xdeadbeef`
    - gas (assuming no mem expansion): `32006`
    - result: `0x70f2b2914A2a4b783FaEFb75f459A580616Fcb5e`


- Example 4
    - address `0x00000000000000000000000000000000deadbeef`
    - salt `0x00000000000000000000000000000000000000000000000000000000cafebabe`
    - init_code `0xdeadbeef`
    - gas (assuming no mem expansion): `32006`
    - result: `0x60f3f640a8508fC6a86d45DF051962668E1e8AC7`


- Example 5
    - address `0x00000000000000000000000000000000deadbeef`
    - salt `0x00000000000000000000000000000000000000000000000000000000cafebabe`
    - init_code `0xdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeefdeadbeef`
    - gas (assuming no mem expansion): `32012`
    - result: `0x1d8bfDC5D46DC4f61D6b6115972536eBE6A8854C`


- Example 6
    - address `0x0000000000000000000000000000000000000000`
    - salt `0x0000000000000000000000000000000000000000000000000000000000000000`
    - init_code `0x`
    - gas (assuming no mem expansion): `32000`
    - result: `0xE33C0C7F7df4809055C3ebA6c09CFe4BaF1BD9e0`






[ethervm.io]: https://www.ethervm.io/